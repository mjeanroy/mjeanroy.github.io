---
layout: post
title:  "Prismic @ Malt"
tags: ['tech', 'prismic', 'malt']
---

*Cet article a initialement √©t√© publi√© sur [medium](https://medium.com/nerds-malt/prismic-malt-2f59b96c18a9).*

![Prismic @ Malt](/static/assets/prismic-malt.png)

Au mois d‚Äôoctobre 2020, nous avons lanc√© la nouvelle identit√© de Malt, cela a √©t√© l‚Äôoccasion de repenser la nouvelle charte graphique (les √©quipes Brand & Design de Malt pourront vous parler bien mieux que moi de tous les challenges associ√©s), mais aussi le contenu.

Ce projet n‚Äôa pas seulement √©t√© l‚Äôoccasion d‚Äôimpl√©menter notre nouveau Design System, cela a √©t√© aussi l‚Äôoccasion d‚Äôintroduire dans notre produit un CMS Headless, √† savoir [Prismic](https://prismic.io).

Voici donc un peu plus de d√©tails sur la mise en place de cet outil et ce que nous avons appris.

### Why ?

Avant de parler technique, la question essentielle est : pourquoi avoir choisi de mettre en place un CMS Headless ?

Pour r√©pondre √† cette question, j‚Äôai besoin de revenir un peu en arri√®re pour parler du contexte √† l‚Äô√©poque de ce choix.
Si on revient au tout d√©but de l‚Äôann√©e 2020, nous avons sur le site de Malt plusieurs landing pages, dont le contenu est g√©r√© par l‚Äô√©quipe Marketing. √Ä l‚Äô√©poque o√π toutes ces pages sont cr√©√©es (en 2018‚Äì2019), nous n‚Äôavons pas de CMS, le choix est donc d‚Äôaller au plus simple et au plus vite : nous d√©veloppons des pages (quasiment) statiques, traduites dans diverses langues correspondant aux d√©clinaisons internationales du site (Espagnol, Allemand, etc.).

Je dis "quasiment" statiques car le contenu √©tant internationalis√©, celui-ci est g√©r√© via notre outil de gestion de traduction, √† savoir [Phraseapp](https://phrase.com/fr/), auquel les √©quipes marketing ont acc√®s.

Avoir des landing pages "statiques" a des avantages (rapidit√© de mise en place, gestion des √©volutions c√¥t√© √©quipe tech, etc.) mais le process de mise √† jour du contenu est assez fastidieux :

1. L‚Äô√©quipe Marketing fait ses modifications dans [Phraseapp](https://phrase.com/fr/), pour √ßa ils ont besoin de conna√Ætre pr√©cis√©ment la cl√© de traduction √† modifier qui n‚Äôest pas toujours √©vidente √† conna√Ætre.
2. Une fois les modifications faites, la mise √† jour en production passe g√©n√©ralement par un ticket Jira pour demander l‚Äôupdate (r√©cup√©ration des traductions + tests sur notre environnement d‚Äôint√©gration).
3. D√©ploiement en production.

Entre la modification initiale et la mise √† jour en production, il peut s‚Äô√©couler entre une demi-journ√©e et deux jours suivant la r√©activit√© de l‚Äô√©quipe produit, [ce qui est bien mais pas top](https://youtu.be/b6ycU7Tsnzk?t=72) :)
Nous avons donc d√©cid√© de mettre en place un CMS Headless pour rendre nos √©quipes marketing autonomes sur le contenu et leur laisser la main sur la publication en production.

La mise en place de ce CMS va donc avoir les objectifs suivants :
- Rendre les √©quipes de Malt plus autonomes : la modification du contenu ne doit pas faire intervenir les √©quipes produits, et la mise √† jour en production doit pouvoir se faire en quelques minutes.
- Cr√©er du nouveau contenu doit √™tre simple pour tout le monde, m√™me sans connaissance technique.

### What ?

Afin de faire √©voluer notre produit, nous avons introduit un nouveau [produit dans le produit](https://www.imdb.com/title/tt1375666/), √† savoir [Prismic](https://prismic.io). Voyons un peu plus dans le d√©tail pourquoi nous l‚Äôavons choisi.

Prismic est un CMS Headless : si vous ne savez pas ce qu‚Äôest un CMS Headless, on peut le r√©sumer simplement comme √©tant un outil d‚Äô√©dition de contenu nous donnant acc√®s √† une API pour les documents que nous √©ditons. Cela se diff√©rencie d‚Äôun CMS type Wordpress, car dans le cas de Prismic, nous consommons uniquement l‚ÄôAPI et le rendu se fait int√©gralement dans notre codebase (avec nos templates que nous √©crivons).

Lorsque nous avons √©valu√© les CMS Headless du march√©, trois outils sont sortis du lot :
- [Prismic](https://prismic.io/)
- [Contentful](https://www.contentful.com/)
- [Strapi](https://strapi.io/)

Nous avons √©limin√© [Strapi](https://strapi.io/) quasiment d‚Äôembl√©e car nous souhaitions un outil SaaS (sans jugement n√©gatif, √ßa ne correspondait juste pas √† notre besoin). Le choix s‚Äôest donc concentr√© sur [Contentful](https://www.contentful.com/) vs [Prismic](https://prismic.io/) et pour cela nous avons √©labor√© quelques crit√®res qui nous paraissaient primordiaux :
- Un pricing que l‚Äôon peut anticiper.
- Gestion de l‚Äôinternationalisation et des localisations : la solution choisie a besoin d‚Äô√™tre compatible avec tous nos sites localis√©s (www.malt.fr, en.malt.fr, www.malt.de, en.malt.de, etc.).
- Clients disponibles : id√©alement un SDK "natif‚Äù ou au minimum une API Rest qu‚Äôon peut interroger facilement.

Ces trois crit√®res ont guid√© notre choix vers [Prismic](https://prismic.io/) :
- Le pricing est clair : un abonnement annuel, pas de facturation en fonction de la consommation.
- La gestion de l‚Äôinternationalisation qui correspond exactement √† ce que l‚Äôon recherche.
- Une API Rest, et m√™me GraphQL, assez simple √† comprendre et utiliser.

### How ?

Reste maintenant la partie tech, √† savoir la mise en place de Prismic dans notre codebase.

#### Comment interroger l‚ÄôAPI ?

Pour l‚Äôint√©grer au mieux dans notre codebase, il nous appara√Æt clairement que nous devons l‚Äôadapter √† notre stack Java. √Ä l‚Äôinverse, adapter notre stack √† la mise en place de Prismic nous parait contre-productif et risqu√© (sans rentrer dans les d√©tails, cela demande de revoir certaines "briques‚Äù cl√©s dans notre architecture).

Prismic met √† disposition des SDK dans diff√©rents langages, mais malheureusement le SDK Java semble plus ou moins √† l‚Äôabandon ; la priorit√© √©tant mise sur le SDK JS √† utiliser dans une app React / VueJS / etc. Utiliser ce type de fonctionnement parait fun au premier abord (frameworks SPA + Server Side Rendering entre autres), mais cela nous demande pas mal de modifications pour l‚Äôint√©grer proprement √† nos applications Spring Boot.

On d√©cide donc de r√©-√©crire notre propre client consommant l‚ÄôAPI Rest de Prismic. Fort heureusement, √©crire un client Rest est quelque chose qu‚Äôon sait plut√¥t bien faire chez Malt, et cela ne nous prend que tr√®s peu de temps :)

#### Mise en place

Afin de bien s‚Äôint√©grer avec le fonctionnement de [Prismic](https://prismic.io) ([Slice](https://user-guides.prismic.io/en/articles/383933-slices), etc.), on d√©cide de garder l‚Äôapproche "Component‚Äù, mais pour cela nous n‚Äôallons pas utiliser de frameworks JS orient√©s Composants (Angular, React, VueJS, etc.).

Nous allons plut√¥t prendre cette approche :
- Pour chaque slice Prismic*, nous avons un template handlebars qui lui correspond.
- Pour chaque slice Prismic*, nous d√©finissons le style qui lui correspond (un fichier sass pour chaque composant en gros), pour lequel nous "scopons‚Äù les styles en utilisation la notation [BEM](https://css-tricks.com/bem-101/).
- √âventuellement, nous avons la possibilit√© d‚Äôajouter un peu de JS pour nos composants Prismic, mais cela s‚Äôav√©rera tr√®s (tr√®s) rare, chaque composant ayant un rendu purement statique ne n√©cessitant pas / peu de logique c√¥t√© browser. En somme, on fait du "progressive enhancement‚Äù üôÇ

_*Dans Prismic, un slice peut √™tre vu comme composant de plus "haut niveau‚Äù (haut niveau, dans le sens "pas un champ de saisie‚Äù), typiquement, une section de contenu dans une landing page._

En faisant le choix de ne pas utiliser le [SDK Java de Prismic](https://github.com/prismicio/java-kit), nous devons r√©-impl√©menter certaines choses (forc√©ment, le SDK ne se r√©sume pas seulement √† un client HTTP). L‚Äôutilisation d‚ÄôHandlebars nous permet de centraliser certaines parties sous forme de Helper de mani√®re assez souple :
- Nous r√©-impl√©mentons le fonctionnement du ["RichText"](https://user-guides.prismic.io/en/articles/383762-rich-text) Prismic. Ce sera fait sous la forme d‚Äôun [helper Handlebars](https://jknack.github.io/handlebars.java/helpers.html) que l‚Äôont pourra utiliser partout.
- Nous r√©-impl√©mentons √©galement le fonctionnement des ["Links"](https://user-guides.prismic.io/en/articles/383950-link) Prismic sous forme de [Helper](https://jknack.github.io/handlebars.java/helpers.html).

Enfin, nous mettons en place from scratch le fonctionnement des Preview. Pour l‚Äôanecdote, cela m‚Äôam√®nera √† remonter un probl√®me de s√©curit√©. Heureusement, l‚Äô√©quipe Support de Prismic est top, r√©pond vite et m‚Äôa remerci√© par quelques Goodies ‚ù§Ô∏è

#### R√©sultat

Voici une vue g√©n√©rale de l‚Äôarchitecture que nous avons aujourd‚Äôhui en place :

![Prismic @ Malt](/static/assets/prismic-malt-stack.svg)

Nous avons donc :
- Une JSP incluant les templates Handlebars correspondant aux slices √† afficher √† l‚Äô√©cran (et d√©termin√©s dynamiquement par le document Prismic √† afficher).
- Ces JSP sont servies par nos apps Spring Boot communiquant directement avec l‚Äôapi Rest de Prismic.
- Un cache au milieu.

La mise en place du cache n‚Äô√©tait pas obligatoire mais il y a ici deux objectifs principaux :
- Economiser les appels √† Prismic (gain en perf pour afficher une page, [√©conomie de bande passante](https://www.greenpeace.fr/la-pollution-numerique/), etc.)
- Avoir un fallback "d√©grad√©‚Äù pour le cas o√π la communication avec Prismic tomberait. Bon, dans les faits √ßa n‚Äôest jamais arriv√© : Prismic fonctionne terriblement bien (et super rapidement). Mais tout de m√™me cela pourrait arriver, et [m√™me aux meilleurs](https://www.theverge.com/2020/6/29/21306674/github-down-errors-outage-june-2020), et c‚Äôest aussi notre job de pr√©voir l‚Äôimpr√©visible.

Et gr√¢ce aux [webhooks](https://user-guides.prismic.io/en/articles/790505-webhooks) que l‚Äôon peut configurer dans Prismic, le cache est automatiquement invalid√© √† chaque publication d‚Äôun document, tout est donc automatis√© üî•

### Bilan

Cela va faire maintenant 4 mois que tout cela est en place, et on peut d√©j√† en tirer un bilan :
- Globalement, les √©quipes Marketing sont devenues nettement plus autonomes. Il y a encore des am√©liorations √† faire, tout n‚Äôest pas parfait non plus, mais aujourd‚Äôhui un changement de texte ne n√©cessite plus du tout l‚Äôintervention de l‚Äô√©quipe produit, et la mise √† jour en prod se fait en quelques clics.
- Nous avons utilis√© cette solution pour d‚Äôautres besoins que des landing pages marketing. Par exemple l‚Äô√©quipe Community publie r√©guli√®rement des super s√©lections de profils freelances en totale autonomie, par exemple la [s√©lection d‚Äôing√©nieur devops](https://www.malt.fr/selection/devops) (aucune de ces pages n‚Äôa n√©cessit√© d‚Äôintervention de l‚Äô√©quipe produit).
- Nous avons aussi permis aux √©quipes Marketing de d√©ployer [des pages enti√®res sans aucune intervention de l‚Äô√©quipe produit](https://en.malt.de/c/malt-start), et √ßa c‚Äô√©tait clairement une promesse difficile √† croire au d√©but :)

Personnellement, j‚Äôai trouv√© le produit Prismic vraiment excellent (et pourtant je faisais partie des sceptiques, probablement √©chaud√© par les CMS type Wordpress & cie).

Et si vous voulez mettre les mains dans le cambouis pour am√©liorer notre solution, [n‚Äôh√©sitez pas √† venir nous en parler](https://careers.malt.com/careers) !